# ETL-конвейер для интеграции ГрандСметы с 1C

## Контекст проекта

Строительной организации требовался инструмент для:

-   **планирования закупок и затрат** на этапе проектирования,
    
-   **контроля цен при участии в тендерах**,
    
-   **сопоставления плановых и фактических объемов ресурсов**.
    

Также компания столкнулась с серьезной проблемой:  
так как учетная система не позволяла планировать ресурсы заранее - это приводило к:

-   перепродаже излишков подрядчиками,  
-   экономии материалов на объекте с целью перепродажи,
-   постоянному перерасходу материалов.
    
Основная сметная информация формировалась в **ГрандСмете**, а учет велся в **БИТ.Строительство**.  
Переход на 1С:ERP был признан экономически нецелесообразным, поэтому было принято решение поэтому было решено **разработать собственный функционал** аналогичный сметной подсистеме в 1C:ERP Управление строительной организацией.
Первоначально компания обратилась в организацию-разработчика БИТ.Строительство однако результат
оказался крайне неудовлетворительным, и разработку пришлось начать с нуля собственными силами.

----------

##  Архитектура решения

Были разработаны и переработаны следующие компоненты:

-   **Документ "Ведомость объема работ"**  ***
    Полностью заменяет стандартный документ.  
    Его ключевые особенности:
    
    -   Предоставляет удобный интерфейс для работы с ВОР (drag&drop, древовидная структура элементов)
    - автоматическое заполнение и проверку определенных свойств
        
    -   детализацию по разделам, работам, материалам и технике.
    
    - возможность на лету установить замену номенклатуре и сохранить особенности расчетов
    - установку собственных коэффициентов
    - перераспределение отрицательных показателей на другие виды работ
    - отражение подчиненных работ и конструктивных элементов    
-   **Документ "Заявка на тендер"** (разработка с нуля)  ***
Именно этот документ определяет состав и содержание итогового комплекта документов подаваемых на тендер:
	- Состав доступных элементов и функций определяется ролью пользователя в процессе согласования, наличия у него визы, и статуса самого процесса согласования

	- Устанавливает общую по проекту информацию
	- Позволяет в специализированной форме подбора выбрать набор необходимых для проекта видов работ, техники и материалов с контролем остатков по всем элементам
	- Позволяет установить плановые расходы и фактические расходы, с учетом возможности в будущем замены материалов и работ, изменения сроков, с автоматическим пересчетом показателей
-   **Документ "Проект договора"** (глубокий рефакторинг)
для соответствия стандартам разработки принятым в компании, а также для поддержки разрабатываемого процесса был проведен масштабный рефакторинг кода этого документа
-   **ETL-обработка (данный репозиторий)**  ***
    Парсинг, трансформация, расчеты и загрузка сметы в учетную систему.
    
-   **Бизнес-процесс согласования**  
    Автоматизация задач от создания проекта до подачи заявки и контроль статусов и доступности объектов
 
-   **Различные отчеты**

----------

## Цель ETL-конвейера

На основе **XML-сметы из ГрандСметы**:

-   Воспроизвести все расчеты, которые ГрандСмета не сохраняет
    
-   преобразовать линейную структуру сметы в древовидную определив принадлежность объектов на основе косвенных признаков,
    
-   сопоставить:
    
    -   виды работ разделам,
        
    -   материалы и технику видам работ,
    -  определить подчиненные виды работ
        
-   загрузить результат в документ **"Ведомость объема работ"**.
    

### Ключевая особенность

> ГрандСмета **не сохраняет результаты вычислений**, поэтому весь расчетный механизм был воспроизведен вручную на основе XML-структуры и XSD-схем.

Некоторые элементы документа, коэффициенты и показатели, **не были документированы в системе ГрандСмета**, и их назначение извлекалось из аннотаций к типам в схеме.  Да, [было больно](https://xsd.grandsmeta.ru/ls/) :)

----------

## Примеры требований из ТЗ

### 1. Сопоставление номенклатуры

-   Разработать механизм сопоставления работ и материалов (один раз настроил — дальше автоматом).
    
-   Несопоставленные позиции выделяются и **запрещают проведение документа**.
    

### 2. Связь работ и материалов

-   Материал должен быть связан с работой для контроля:  
    **объем работ = объем материалов**.
    

### 3. Детализация по разделам

-   Разделы сметы должны сохраняться в структуре данных.
    

### 4. Колонка "Этаж"

-   Ручной ввод + автозаполнение по разделу/виду работ.
    

### 5. Корректировки

-   Хранение истории корректировок.
    
-   При удалении раздела — предложение заменить или удалить связанные данные.
    

### 6. Отрицательные позиции

-   Возможность вручную перераспределять отрицательные значения на другие работы/материалы.
    

### 7. Материалы заказчика / подрядчика

-   Должны определяться символом, колонкой или цветом
    

### 8. Формат загрузки

-   XML из ГрандСметы.
    

----------

##  Какие были сложности

-   Материал мог не принадлежать ни одной работе.
    
-   Работа могла быть одновременно и работой и материалом или техникой.
    
-   Работы и материалы могли быть связаны цепочкой, но находиться в разных разделах.
    
-   Один вид работ мог ссылаться на другой (с собственными материалами и техникой).
    
-   Произвольные названия в ГрандСмете и конкретная номенклатура в 1С 
    -> десятки разных наименований означали один и тот же объект справочника.
    
-   ГрандСмета не обновляла XSD при обновлениях, схему приходилось дорабатывать вручную.
  
  - Менялись руководители сметного отдела, и у каждого было свое видение

----------

##  Результат

В итоге был реализован **полноценный ETL-pipeline**, который:

-   читает XML-смету,
    
-   воспроизводит все расчеты,
    
-   выполняет сложные сопоставления,
    
-   возвращает данные в виде **древовидной структуры**, полностью соответствующей смете,
    
-   преобразует структуру в удобные деревья в документе 1С.
    

----------